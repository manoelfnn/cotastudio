import Interpretador from"../linguagem/Interpretador";import funcoes from"../linguagem/funcoes";import TokensTipos from"../linguagem/tokens";import exemplos from"../exemplos";import testes from"../linguagem/testes";import Config from"./config";import TControle from"../linguagem/controles/TControle";let contador=0;localStorage.getItem("primeiro")||$("#sobreModal").modal();const config=new Config;let editor;config.carregar(),exemplos.forEach(categoria=>{const exemplosMenus=categoria.exemplos.map(exemplo=>(contador+=1,`<div>\n        <a data-dismiss="modal" acao="carregar-exemplo" href="#" categoria="${categoria.nome}" exemplo="${exemplo.nome}" title="${exemplo.descricao}">\n            <i class="fa fa-fw fa-file-o"></i>    \n            ${contador}. \n            ${exemplo.nome}</a>\n        </div>`));$("#exemplosModalLista").append(`\n        <div class="mb-3">\n            <a>${categoria.nome}</a>\n            <div>${exemplosMenus.join("")}</div>\n        </div>`)});const inter=new Interpretador("secao-janela","saida",(i,m,p)=>{p&&editor.addLineClass(p.linha-1,"","linha-erro")});window.global={palavrasReservadas:[],funcoesDoSistema:funcoes.map(funcao=>funcao.nome),funcoesDoUsuario:[],variaveisGlobais:[]},TokensTipos.forEach(token=>window.global.palavrasReservadas.push(...token.variacoes)),console.log(`Total de funções: ${funcoes.length}`),funcoes.forEach(funcao=>{const parametros=funcao.parametros.join(", ");$("#ajudaFuncoesSistema tbody").append(`<tr><td><span class="nome">${funcao.nome}(<i>${parametros}</i>)<br><small>${funcao.descricao}</small></td></tr>`)}),CodeMirror.registerHelper("hint","anyword",(editor,options)=>{const WORD=/[\w$_áàâãéèêíïóôõöúçñÁÀÂÃÉÈÍÏÓÔÕÖÚÇÑ]/,word=options&&options.word||WORD,cur=editor.getCursor(),curLine=editor.getLine(cur.line);let start=cur.ch,end=start;for(;end<curLine.length&&word.test(curLine.charAt(end));)end+=1;for(;start&&word.test(curLine.charAt(start-1));)start-=1;const curWord=start!==end&&curLine.slice(start,end),list1=window.global.funcoesDoSistema.sort(),list2=window.global.funcoesDoUsuario.sort();let list=list2.concat(list1);return curWord&&(list=list.filter(e=>-1!==e.indexOf(curWord))),{list:list,from:CodeMirror.Pos(cur.line,start),to:CodeMirror.Pos(cur.line,end)}});let carregado=!1,intervalo=null;function executarComando(comando,elemento=null){switch(comando){case"caracter":{let caracter=elemento.attr("caracter");const voltar=elemento.attr("posicao")?parseInt(elemento.attr("posicao"),10):null;if("tab"===caracter&&(caracter="    "),editor.focus(),editor.replaceSelection(caracter),null!==voltar){const cursor=editor.getCursor();editor.setCursor({line:cursor.line,ch:cursor.ch+voltar})}break}case"maximizar-saida":$(".CodeMirror").toggle(),$(".secao-saida").css("flex-grow","1"===$(".secao-saida").css("flex-grow")?"initial":"1");break;case"exibir-saida":$(".secao-saida").toggle();break;case"abrir-saida":$(".secao-saida").show();break;case"fechar-saida":$(".secao-saida").hide(),$(".CodeMirror").show(),$(".secao-saida").css("flex-grow","initial");break;case"abrir-caracteres":$(".secao-caracteres").show();break;case"fechar-caracteres":$(".secao-caracteres").hide();break;case"fechar-janela":inter.destruirDisparadores(),$("#secao-janela").html("");break;case"fechar-variaveis":$(".secao-variaveis").hide();break;case"abrir-variaveis":$(".secao-variaveis").show();break;case"novo":window.confirm("Deseja realmente criar um novo código?")&&editor.setValue("");break;case"abrir":$("#arquivo").click();break;case"desfazer":editor.execCommand("undo");break;case"refazer":editor.execCommand("redo");break;case"config-abrir":config.carregar();break;case"config-salvar":config.salvar();break;case"salvar":{const bb=new Blob([editor.getValue()],{type:"text/plain"}),a=document.createElement("a"),data=new Date,agora=`d${data.getDate()}${data.getMonth()}${data.getFullYear()}h${data.getHours()}${data.getMinutes()}${data.getSeconds()}`;a.download=`${agora}.cota`,a.href=window.URL.createObjectURL(bb),a.click();break}case"carregar-exemplo":{const categoria=elemento.attr("categoria"),exemplo=elemento.attr("exemplo"),{codigo:codigo}=exemplos.find(e=>e.nome===categoria).exemplos.find(e=>e.nome===exemplo);editor.setValue(codigo);break}case"executar-rapido":{desmarcarTodasLinhas();const magico=elemento&&"true"===elemento.attr("magico");executando(!0,"rapido"),inter.carregar(editor.getValue(),!1)&&inter.executarTudo(magico),executando(!1,"rapido");break}case"executar-linha":if(!carregado&&inter.carregar(editor.getValue(),!0)&&(carregado=!0),executando(!0,"linha"),carregado){const execucao=inter.executarProximaLinha();$(".secao-variaveis .variaveis").html(inter.verVariaveis()),desmarcarTodasLinhas(),marcarLinha(inter.linhaAtual-1,"atual"),execucao||(carregado=!1,executando(!1,"linha"))}else executando(!1,"linha");break;case"executar-lento":executando(!0,"lento"),inter.carregar(editor.getValue(),!0)?intervalo=setInterval(()=>{const execucao=inter.executarProximaLinha();$(".secao-variaveis .variaveis").html(inter.verVariaveis()),desmarcarTodasLinhas(),marcarLinha(inter.linhaAtual-1,"atual"),execucao||(clearInterval(intervalo),executando(!1,"lento"))},150):executando(!1,"lento");break;case"executar-parar":executando(!1,"parar"),intervalo&&clearInterval(intervalo),inter.carregar(editor.getValue(),inter.getDebug()),carregado=!1;break;case"ver-bytecode":case"ver-tokens":inter.carregar(editor.getValue(),!1),"ver-bytecode"===comando?($("#codigoModalTitle").text("Bytecode do código"),$("#codigoModalCodigo").html(inter.bytecodesEmTexto())):($("#codigoModalTitle").text("Tokens do código"),$("#codigoModalCodigo").html(inter.tokensEmTexto())),$("#codigoModal").modal("show");break;case"ajuda":$("#ajudaModal").modal("show");break;case"testes":testes();break;default:return!1}return!0}function marcarLinha(linha,tipo){editor.addLineClass(linha,"",`linha-${tipo}`)}function desmarcarTodasLinhas(){const linhas=editor.lineCount();for(let i=0;i<linhas;i+=1)editor.removeLineClass(i,"","linha-atual"),editor.removeLineClass(i,"","linha-erro")}function executando(estado,modo){estado&&console.clear(),estado&&desmarcarTodasLinhas(),editor.setOption("readOnly",estado),executarComando(estado?"fechar-caracteres":"abrir-caracteres"),executarComando(!estado||"lento"!==modo&&"linha"!==modo?"fechar-variaveis":"abrir-variaveis"),executarComando("abrir-saida"),$("[acao=executar-parar]").prop("disabled",!estado),$("[acao=abrir]").prop("disabled",estado),$("[acao=salvar]").prop("disabled",estado),$("#maisOpcoes").prop("disabled",estado),estado?"lento"===modo||"rapido"===modo?($("[acao=executar-rapido]").prop("disabled",!0),$("[acao=executar-lento]").prop("disabled",!0),$("[acao=executar-linha]").prop("disabled",!0)):($("[acao=executar-rapido]").prop("disabled",!0),$("[acao=executar-lento]").prop("disabled",!0),$("[acao=executar-linha]").prop("disabled",!1)):($("[acao=executar-rapido]").prop("disabled",!1),$("[acao=executar-lento]").prop("disabled",!1),$("[acao=executar-linha]").prop("disabled",!1))}editor=CodeMirror.fromTextArea($("#editor")[0],{lineNumbers:!0,mode:"vgpp",theme:"monokai",lineWrapping:!0,autoRefresh:!0,extraKeys:{"Ctrl-Space":"autocomplete",F1:()=>executarComando("ajuda"),F2:()=>executarComando("abrir"),F3:()=>executarComando("salvar"),F4:()=>executarComando("exibir-saida"),F7:()=>executarComando("exibir-linha"),F8:()=>executarComando("executar-lento"),F9:()=>executarComando("executar-rapido"),F10:()=>executarComando("ver-tokens"),F11:()=>executarComando("ver-bytecode")}}),config.atualizar(editor),editor.on("change",()=>{localStorage.setItem("codigo",editor.getValue()),desmarcarTodasLinhas()}),editor.on("focus",()=>{executarComando("fechar-saida"),executarComando("abrir-caracteres"),desmarcarTodasLinhas()}),editor.on("blur",e=>{}),editor.focus(),[["contextmenu","botao-direito"],["click","clique"],["dblclick","duplo-clique"],["keypress","teclar"],["keydown","pressionar-tecla"],["keyup","soltar-tecla"],["mousemove","mover-mouse"],["mouseenter","entrar-mouse"],["mouseover","mouse-acima"],["mouseleave","mouse-deixar"],["mouseout","mouse-saiu"],["mousedown","mouse-pressionar"],["mouseup","mouse-soltar"]].forEach(e=>{$(document).on(e[0],`[evento-${e[1]}]`,(function(evento){"mousemove"===e[0]?inter.chamarFuncao($(this).attr(`evento-${e[1]}`),[new TControle($(this)),evento.clientX,evento.clientY]):["keypress","keydown","keyup"].indexOf(e[0])>-1?inter.chamarFuncao($(this).attr(`evento-${e[1]}`),[new TControle($(this)),evento.key]):inter.chamarFuncao($(this).attr(`evento-${e[1]}`),[new TControle($(this))])}))}),$("#arquivo").change((function arquivoChange(e){const file=e.target.files[0],fr=new FileReader;fr.readAsText(file),fr.onload=function arquivoOnLoad(){editor.setValue(fr.result)}})),$(document).on("click","[acao]",(function(){executarComando($(this).attr("acao"),$(this))}));const myTour={id:"myTour",bubbleWidth:230,showPrevButton:!0,showCloseButton:!0,showNumber:!1,i18n:{nextBtn:"Próximo",prevBtn:"Voltar",doneBtn:"Ok",skipBtn:"Pular"},steps:[{title:"Editor de código",content:"Step 1 Content",target:"#editor",placement:"bottom"},{xOffset:-80,arrowOffset:80,title:"Novo código",content:"Step 2 Content",target:".btn-novo",placement:"top"},{xOffset:-80,arrowOffset:80,title:"Executar código",content:"Step 3 Content",target:".btn-executar-rapido",placement:"top"},{xOffset:-40,arrowOffset:40,title:"Parar código",content:"Step 4 Content",target:".btn-parar",placement:"top"},{xOffset:-100,arrowOffset:100,title:"Executar passo à passo",content:"Step 5 Content",target:".btn-executar-linha",placement:"top"},{xOffset:-160,arrowOffset:160,title:"Preenchimento automático",content:"Step 6 Content",target:".btn-executar-rapido-auto",placement:"top"},{xOffset:-200,arrowOffset:200,title:"Saída",content:"Step 7 Content",target:".btn-exibir-saida",placement:"top"},{xOffset:-240,arrowOffset:240,title:"Menu",content:"Step 8 Content",target:".btn-menu",placement:"top"}],onStart(){$("body").append('<div id="tour-fundo" style="background-color: black; opacity: .2; height: 100%; width: 100%; position: fixed; z-index: 100000; top: 0; left: 0;"></div>')},onEnd(){$("#tour-fundo").remove()}};localStorage.getItem("tour")||(localStorage.setItem("tour",!0),hopscotch.startTour(myTour));